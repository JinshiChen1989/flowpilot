---
name: I2C Threading Pattern Implementation
status: open
created: 2025-08-29T18:59:14Z
updated: 2025-08-29T19:17:38Z
last_sync: 2025-08-29T19:17:38Z
github: https://github.com/JinshiChen1989/nagasware/issues/4
depends_on: []
parallel: true
conflicts_with: []
---

# Task: I2C Threading Pattern Implementation

## Description
Implement simple I2C threading pattern based on proven Adafruit/DFRobot examples from submodules. Each sensor gets independent SMBus connection with threading.Lock() protection - no complex coordination needed.

## Acceptance Criteria
- [ ] Create `I2CSensorBase` class following Adafruit pattern with independent SMBus connections
- [ ] Implement threading.Lock() per sensor for thread safety (proven pattern)
- [ ] Add exponential backoff retry pattern (from RK3588 examples: 1ms, 2ms, 4ms delays)
- [ ] Create producer-consumer threading pattern (v4l2_camera style)
- [ ] Test pattern with existing I2C sensors on I2C1 bus

## Technical Details
Based on real patterns from submodules:
```python
class I2CSensorBase(rclpy.Node):
    def __init__(self, bus_number=1, address=0x68):
        super().__init__('sensor_node')
        # Independent SMBus per sensor (Adafruit pattern)
        self.i2c_bus = smbus.SMBus(bus_number)
        self.i2c_lock = threading.Lock()  # Simple protection
        
        # Producer thread (v4l2_camera pattern)
        self.capture_thread = threading.Thread(target=self._capture_loop)
        self.data_queue = queue.Queue(maxsize=10)
```

## Dependencies
- [ ] Python smbus library installed on RK3588
- [ ] Access to I2C1 bus for testing

## Effort Estimate
- Size: S
- Hours: 12
- Parallel: true (independent implementation)

## Definition of Done
- [ ] I2C threading pattern implemented and tested
- [ ] Works with existing RK3588 I2C hardware
- [ ] Pattern validated with at least one sensor (IMU or light)
- [ ] Code follows proven Adafruit/DFRobot structure from submodules